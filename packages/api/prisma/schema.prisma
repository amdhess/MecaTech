generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Workshop {
  id          String   @id @default(uuid())
  name        String
  cnpj        String?
  address     String?
  phone       String?
  
  users       UsersOnWorkshops[] 
  
  clients       Client[]
  vehicles      Vehicle[]
  parts         Part[]
  services      Service[]
  serviceOrders ServiceOrder[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Role {
  ADMIN
  MECHANIC
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  avatarUrl String?
  
  workshops UsersOnWorkshops[]

  createdClients  Client[]
  createdVehicles Vehicle[]
  createdOrders   ServiceOrder[]
  
  createdParts    Part[]
  createdServices Service[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UsersOnWorkshops {
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  role       Role     @default(MECHANIC) 

  assignedAt DateTime @default(now())

  @@id([userId, workshopId])
}

model Client {
  id        String   @id @default(uuid())
  name      String
  phone     String?
  email     String?  
  
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  vehicles  Vehicle[]
  deletedAt DateTime? 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, workshopId])
}

model Vehicle {
  id      String  @id @default(uuid())
  plate   String  
  model   String
  brand   String
  year    Int
  color   String?

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  serviceOrders ServiceOrder[]
  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([plate, workshopId])
}

model Part {
  id    String @id @default(uuid())
  name  String
  sku   String 
  stock Int    @default(0)
  price Float
  
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  deletedAt DateTime?
  serviceOrders PartsOnServiceOrders[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sku, workshopId])
}

model Service {
  id          String  @id @default(uuid())
  name        String  
  description String?
  price       Float   

  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  deletedAt DateTime?
  serviceOrders ServiceOrder[] @relation("ServiceToOrder")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServiceOrder {
  id        String   @id @default(uuid())
  status    ServiceOrderStatus @default(PENDING)
  
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation(fields: [createdById], references: [id])

  parts PartsOnServiceOrders[]
  services Service[] @relation("ServiceToOrder")

  publicToken String @unique @default(cuid())

  totalPartsPrice  Float @default(0)
  totalServicesPrice Float @default(0)
  totalPrice         Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PartsOnServiceOrders {
  serviceOrderId String
  serviceOrder   ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  
  partId String
  part   Part @relation(fields: [partId], references: [id])

  quantity Int

  @@id([serviceOrderId, partId])
}

enum ServiceOrderStatus {
  PENDING
  WAITING
  APPROVED
  REJECTED
  IN_PROGRESS
  COMPLETED
  CLOSED
}